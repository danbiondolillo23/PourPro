<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lights Out</title>

  <!--Hosted at https://cs4640.cs.virginia.edu/xtz3mx/hw7-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

  <!--Style from https://stackoverflow.com/questions/19794211/horizontal-scroll-on-overflow-of-table-->
  <style>
    table {
      display: block;
      max-width: 100vw;
      margin: 2px;
      overflow-x: auto;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<div class="container mt-5">
  <h1 class="mb-4">Lights Out</h1>
  <form id="setupForm">
    <div class="row mb-3">
      <div class="col md-6">
        <label for="rows" class="form-label">Rows:</label>
        <input type="number" class="form-control" id="rows" name="rows" min="1" required>
      </div>
      <div class="col md-6">
        <label for="cols" class="form-label">Columns:</label>
        <input type="number" class="form-control" id="cols" name="cols" min="1" required>
      </div>
    </div>
    <button type="submit" class="btn btn-primary">Start Game</button>
  </form>
</div>

<div class="d-flex justify-content-center m-5" id="boardContainer">
  <div class="table-responsive">
    <!-- Table will be inserted here -->
  </div>
</div>

<!-- Win Modal-->
<div class="modal fade" id="winModal" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="winModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="winModalLabel"><i class="far fa-smile"></i> Congratulations, you won!</h5>
      </div>
      <div class="modal-footer">
        <button type="close" class="btn border rounded-5 px-4 py-2" data-bs-dismiss="modal">Exit</button>
      </div>
    </div>
  </div>
</div>

<script>
  let rows, cols;
  let shadedCells = [];

  $(document).ready(function() {
    $('#setupForm').submit(function(event) {
        event.preventDefault();
        rows = $('#rows').val();
        cols = $('#cols').val();
        shadedCells = [];
        startGame(rows, cols);
    });

    function startGame(rows, cols) {
      $.ajax({
          url: 'setup.php',
          method: 'GET',
          data: { rows: rows, cols: cols },
          dataType: 'json',
          success: function(response) {
              // Process response and display game board
              showGameBoard(rows, cols, response);
          },
          error: function(xhr, status, error) {
              console.error(error);
          }
      });
    }

    function showGameBoard(rows, cols, selected) {

      // Add initally selected cells to list
      selected.forEach(index => {
        shadedCells.push(index);
      });

      const responsiveDiv = $('#boardContainer').find('.table-responsive');

      responsiveDiv.empty();

      // Create table
      const table = $('<table class="table table-bordered"></table>');

      // Adjust minimum square size
      const squareSize = Math.min(40/cols, 40/rows);

      // Iterate over rows and create HTML elements
      for (let i = 0; i < rows; i++) {
        // Create table row 
        const row = $('<tr></tr>');

        // create table cells
        for (let j = 0; j < cols; j++) {
          // Calculate the index of the cell
          const cellIndex = i * cols + j;
          
          // Create table cell with numerical id
          const cell = $('<td class="card" id="cell_' + cellIndex + '" style="\
            display: inline-block; \
            min-width: 30px; \
            min-height: 30px; \
            width: ' + squareSize + 'vw; \
            height: ' + squareSize + 'vw; \
            background-color: blue; \
            border: 1px solid black;\
            border-radius: 5px;"></td>'
          );


          if (selected.includes(cellIndex)) {
            cell.css('background-color',  'orange');
          }

          row.append(cell);

          // Attach click event listener to each cell
          cell.click(function() {
            toggleCellColor(cellIndex);
            updateAdjacentCells(i, j)
            console.log(shadedCells.length);
            checkWinCondition();
          });

          // Attach hover event listeners
          cell.hover(
            function() {
              $(this).css('opacity', '0.7');
            },
            function() {
              $(this).css('opacity', '1');
            }
          );
        }

        table.append(row);
      }

      responsiveDiv.append(table);

      checkWinCondition();
    }

    function toggleCellColor(index) {
      const cellIndex = index;
      const cell = $('#cell_' + cellIndex);

      // Toggle cell color between blue and orange
      if (cell.css('background-color') === 'rgb(0, 0, 255)') {
        cell.css('background-color', 'orange');
        shadedCells.push(cellIndex);

      } else {
        cell.css('background-color', 'blue');
        const index = shadedCells.indexOf(cellIndex);
        if (index !== -1) {
          shadedCells.splice(index, 1);
        }
      }
    }

    function updateAdjacentCells(row, col) {
      const offsets = [{row: -1, col: 0}, {row: 1, col: 0}, {row: 0, col: -1}, {row: 0, col: 1}];

      // Iterate to find offsets
      offsets.forEach(offset => {
        const newRow = row + offset.row;
        const newCol = col + offset.col;

        // Check if offset cells are within bounds
        if (newRow >= 0 && newRow < rows && newCol >= 0 && newCol < cols) {
          // Calculate the index of the adj cell
          const adjCellIndex = newRow * cols + newCol;
          toggleCellColor(adjCellIndex);
        }
    });
  }

  function checkWinCondition() {
    // If win
    if (shadedCells.length === rows * cols) {
      const winModal = $('#winModal');
      winModal.modal('show');
      // Turn off clicks
      $('.card').off('click');
    }
  }
});
</script>

</body>
</html>
